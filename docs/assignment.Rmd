---
title: "Assignment 7: Growth"
author: "Bri Baker, Ian Brunjes, & Scout Leonard"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: yes
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load libraries
library(here)
library(sensitivity)
library(tidyverse)
library(deSolve)
library(patchwork)
```

**Consider the following model of forest growth (where forest size in measured in units of carbon (C)):**

- dC/dt = r\*C for forests where C is below a threshold canopy closure;

- dC/dt = g\*(1- C/K) for forests where carbon is at or above the threshold canopy closure;

- and K is a carrying capacity in units of carbon.

\noindent The size of the forest (C), Canopy closure threshold and carrying capacity are all in units of kg carbon

\noindent You could think of the canopy closure threshold as the size of the forest at which growth rates change from exponential to linear

\noindent You can think of r, as early exponential growth rate and g as the linear growth rate once canopy closure has been reached.

# Part 1

\noindent Implement this model in R (as a differential equation) (Grading 25% - we will look for correct implementation but also good programming style - meaningful variable names, comments/documentation throughout,)

```{r implement model}
#source function
source(here("R", "dgrowth.R"))

#view function:
dgrowth
```

\newpage

# Part 2

\noindent Run the model for 300 years (using the ODE solver) starting with an initial forest size of 10 kgC, and using the following parameters: 

- canopy closure threshold of 50 kgC

- K = 250 kgC (carrying capacity)

- r= 0.01 (exponential growth rate before before canopy closure)

- g = 2 kg/year (linear growth rate after canopy closure)

```{r run the model}
# model run time: 300 years
tm = seq(1, 300, 1) 

# initial kilograms of Carbon
Cinit = 10 # initial kilograms of Carbon

#growth parameters:
gps = list(
  
  K = 250, # carrying capacity kg of Carbon
  
  r = 0.01, # exponential rate of growth before canopy closure
  
  g = 2, # linear growth after canopy closure kilograms/year
  
  thresh = 50 # canopy closure threshold (kilograms of carbon)
  
)

#results
res = ode(Cinit, tm, dgrowth, parms = gps)

#rename results columns
colnames(res) = c("time", "carbon")
```

\noindent Graph the results. (15% - we look for an appropriate graphs and good visualization practice - labels, etc)

```{r graph model results, fig.cap= "Growth model over 300 years using ODE Solver, starting with initial forest size of 10 kilograms of carbon and the following parameters: 250 kilograms of carbon carrying capacity, 0.01 exponential growth rate before canopy closure, and 2 kilograms per year growth rate after canopy closure. "}

ggplot(as.data.frame(res), aes(time, carbon)) +
  geom_point() +
  theme_minimal() +
  labs(title = "Forest Growth Model: 300 Years",
       x = "Time (years)",
       y = "Carbon (kilograms)") +
  theme(plot.title = element_text(hjust = 0.5))
```

\newpage

# Part 3

\noindent Run a Sobol sensitivity analysis that explores how the estimated maximum and mean forest size (e.g maximum and mean values of C over the 300 years) varies with the pre canopy closure growth rate (r) and post-canopy closure growth rate (g) and canopy closure threshold and carrying capacity(K).

\noindent Assume that parameters are all normally distributed with means as given above and standard deviation of 10% of mean value

```{r sobol sensitivity analysis}
# Mean parameter values
u_K = 250
u_thresh = 50
u_r = 0.01
u_g = 0.2

# Standard deviation factor
sdf = 0.1

# Build two sample parameter sets
Cinit = 10
np = 100

#sample parmeter set 1:
X1 = cbind.data.frame(
  
  K = rnorm(mean = u_K, sd = u_K * sdf, n = np),
  
  thresh = rnorm(mean = u_thresh, sd = u_thresh * sdf, n = np),
  
  r = rnorm(mean = u_r, sd = u_r * sdf, n = np),
  
  g = rnorm(mean = u_g, sd = u_g * sdf, n = np)
  
)

#sample parameter set 2:
X2 = cbind.data.frame(
  
  K = rnorm(mean = u_K, sd = u_K * sdf, n = np),
  
  thresh = rnorm(mean = u_thresh, sd = u_thresh * sdf, n = np),
  
  r = rnorm(mean = u_r, sd = u_r * sdf, n = np),
  
  g = rnorm(mean = u_g, sd = u_g * sdf, n = np)
  
)

# Create sobol object with parameter sets
sens_carbon = sobolSalt(model = NULL,
                        X1,
                        X2,
                        nboot = 300)

#rename columns of sobol object
colnames(sens_carbon$X) = c("K",
                            "thresh",
                            "r",
                            "g")

parms = sens_carbon$X
```

```{r}
# Run our diffEQ model, extracting max and mean forest carbon

# Function to compute relevant metrics
compute_metrics = function(result) {
  
  maxC = max(result$carbon)
  meanC = mean(result$carbon)
  
  return(list(maxC = maxC, meanC = meanC))
  
}

# Wrapper function for running solver and getting metrics for all params
C_wrapper = function(K, thresh, r, g, Cinit, simtimes, func) {
  
  gps = list(
    K = K,
    r = r,
    g = g,
    thresh = thresh
  )
  
  result = ode(Cinit, simtimes, func, gps, method = "daspk")
  result = as.data.frame(result)
  colnames(result) = c("time","carbon")
  
  metrics = compute_metrics(result)
  return(metrics)
}

# Use pmap with wrapper function to execute against sobol parameters
allresults = as.data.frame(parms) %>%
  pmap(C_wrapper, 
       Cinit = Cinit, 
       simtimes = tm, 
       func = dgrowth)

# extract out results from pmap into a data frame
allres = allresults %>% map_dfr(`[`,c("maxC","meanC"))
```

\noindent Graph the results of the sensitivity analysis as a box plot of maximum forest size and a plot of the two Sobol indices (S and T). (25% - correct implementation of Sobol and graph We also look for good graphing style -labels etc)

```{r sensitivity graphs, fig.caption = "Box plot of the sobol sensitivity analysis results distribution of mean forest carbon values and maximum forest carbon values."}
# plot results
tmp = allres %>%
  gather(key = "metric",
         value = "value")

ggplot(tmp, aes(metric, value, col = metric)) +
  geom_boxplot() +
  theme_minimal() +
  labs(y = "Forest Size (kilograms of carbon)",
       title = "300 Year Growth Model Sobol Sensitivity Results") +
  theme(plot.title = element_text(hjust = 0.5))
```

\noindent The next two code chunks compute the sobol inidces for each metric.

```{r}
# max carbon
sens_carbon_max = sensitivity::tell(sens_carbon, allres$maxC)

#first order indices (main effect without co-variance)
row.names(sens_carbon_max$S) = colnames(parms)

#total sensitivity index
row.names(sens_carbon_max$T) = colnames(parms)

print(sens_carbon_max)
```

```{r}
#mean carbon
sens_carbon_mean = sensitivity::tell(sens_carbon, allres$meanC)

#first order indices (main effect without co-variance)
row.names(sens_carbon_mean$S) = colnames(parms)

#total sensitivity index
row.names(sens_carbon_mean$T) = colnames(parms)

print(sens_carbon_mean)
```

```{r}
# More plotting
# Make data frame for plotting
results_df = cbind.data.frame(
  
  parms,
  mean = sens_carbon_mean$y,
  max = sens_carbon_max$y
  
)

# For max values, threshold then r have most impact
ggplot(results_df, aes(x = thresh, y = max, col = r)) +
  geom_point() +
  labs(y = "Max Carbon Units of Forest",
       x = "Canopy Threshold") +
  theme_minimal()

# For mean values, r then threshold have most impact
ggplot(results_df, aes(x = r, y = mean, col = thresh)) +
  geom_point() +
  labs(y = "Mean Carbon Units of Forest", 
       x = "Initial growth rate (r)") +
  theme_minimal()
```

In 2-3 sentences, discuss what the results of your simulation might mean for climate change impacts on forest growth (e.g think about what parameters climate change might influence ). (25% - we look for reasonable discussion that uses the results from your analysis and give extra points for discussions that offer particularly creative or insightful commentary)

Submit R markdown with model implementation, graphs and sensitivity analysis and R file with your model (Final 10% for well-organized, clearly documented R markdown)

_scout just taking a stab(NOTE I know SO little about forest growth and carbon storage):_

```{r mean plots}
g_mean <- ggplot(results_df, aes(x = g, y = mean)) +
  geom_point() +
  theme_minimal()

thresh_mean <- ggplot(results_df, aes(x = thresh, y = mean)) +
  geom_point() +
  theme_minimal()

r_mean <- ggplot(results_df, aes(x = r, y = mean)) +
  geom_point() +
  theme_minimal()

K_mean <- ggplot(results_df, aes(x = K, y = mean)) +
  geom_point() +
  theme_minimal()

(g_mean + thresh_mean) / (r_mean + K_mean)
```

```{r max plots}
g_max <- ggplot(results_df, aes(x = g, y = max)) +
  geom_point() +
  theme_minimal()

thresh_max <- ggplot(results_df, aes(x = thresh, y = max)) +
  geom_point() +
  theme_minimal()

r_max <- ggplot(results_df, aes(x = r, y = max)) +
  geom_point() +
  theme_minimal()

K_max <- ggplot(results_df, aes(x = K, y = max)) +
  geom_point() +
  theme_minimal()

(g_max + thresh_max) / (r_max + K_max)
```

- i think climate change will 
  - 1.) decrease forest size 
  - 2.) increase (?) initial exponential growth rate 
  - 3.) decrease linear growth rate after canopy closure and 
  - 4.) a decreased carrying capacity 
  - 5.) canopy closure... the same? 
  
From our model output mean carbon is sensitive to:
- r (exponential growth rate)

and max carbon is sensitive to:
- canopy closure threshold and r
